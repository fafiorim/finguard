# FinGuard Test Suite

Comprehensive test suite for validating FinGuard functionality, configurations, and malware detection capabilities.

## Test Scripts

### 1. `test-quick.sh` - Quick Smoke Test
Fast validation of core functionality (~5 seconds)

```bash
./test-quick.sh
```

**Tests:**
- ✓ Health endpoint
- ✓ Authentication
- ✓ EICAR malware detection
- ✓ Scan results API

### 2. `test-all.sh` - Comprehensive Test Suite
Full test suite with all configurations (~30 seconds)

```bash
./test-all.sh
```

**Tests:**
- ✓ Health checks and service status
- ✓ Authentication (admin & user roles)
- ✓ Scanner configurations:
  - PML (Predictive Machine Learning)
  - Verbose results
  - Active content detection
  - SPN feedback
  - Buffer vs File scan methods
- ✓ Security modes (prevent, logOnly, disabled)
- ✓ EICAR malware detection
- ✓ Safe file scanning (samples/safe-file.pdf)
- ✓ Active content detection (samples/file_active_content.pdf)
- ✓ Scan results API

### 3. `test-scanner.py` - Python Test Suite
Detailed Python-based test suite with comprehensive reporting

```bash
python3 test-scanner.py
```

Can be run standalone or via `test-all.sh`

## Prerequisites

### Running Server
Tests require FinGuard to be running:

```bash
# Start with external scanner
docker run -d --name finguard-test \
  -p 3000:3000 -p 3443:3443 \
  -e SCANNER_EXTERNAL_ADDR=10.10.21.201:50051 \
  -e SCANNER_USE_TLS=false \
  finguard:latest

# Or start with SaaS scanner
docker run -d --name finguard-test \
  -p 3000:3000 -p 3443:3443 \
  -e FSS_API_KEY=your-api-key-here \
  finguard:latest
```

### Python Dependencies
```bash
pip3 install requests
```

## Configuration

Override default values using environment variables:

```bash
export FINGUARD_URL="http://localhost:3000"
export ADMIN_USER="admin"
export ADMIN_PASS="admin123"
export USER_USER="user"
export USER_PASS="user123"

./test-all.sh
```

## Test Files

### EICAR Test File
The EICAR test file is automatically generated by the test scripts. It's a standard anti-malware test file that should always be detected as malware.

### Sample Files
Located in `samples/` directory:
- `safe-file.pdf` - Clean PDF file (should pass)
- `file_active_content.pdf` - PDF with active content/scripts

## Expected Results

### Successful Run
```
============================================
FinGuard Comprehensive Test Suite
============================================

Testing Health Check
✓ Health check returns healthy status
  Scanner: healthy
  Security Mode: logOnly

Testing Authentication
✓ Admin authentication
✓ User authentication
✓ Invalid credentials rejected

Testing Scanner Configurations
✓ Configuration: PML Enabled
✓ Configuration: Verbose Enabled
✓ Configuration: Active Content Enabled
✓ Configuration: All Features Enabled
✓ Configuration: Buffer Scan Method
✓ Configuration: File Scan Method

Testing Security Modes
✓ Security mode: prevent
✓ Security mode: logOnly
✓ Security mode: disabled

Testing EICAR Detection
✓ EICAR detected as malware
  Scan ID: 20260207150405-eicar.txt

Testing Safe File: safe-file.pdf
✓ Safe file safe-file.pdf detected as clean
  Scan ID: 20260207150410-safe-file.pdf

Testing Active Content: file_active_content.pdf
✓ Active content file file_active_content.pdf scanned successfully
  Scan ID: 20260207150415-file_active_content.pdf
  Safe: false

Testing Scan Results API
✓ Scan results API accessible
  Total scans in history: 3

=== Test Summary ===
Total Tests: 16
Passed: 16
Failed: 0
Skipped: 0

✓ All tests passed!
```

## Troubleshooting

### Server Not Accessible
```
✗ FinGuard server is not accessible at http://localhost:3000
```
**Solution:** Start the FinGuard container first

### Authentication Failures
```
✗ Admin authentication: HTTP 401
```
**Solution:** Verify credentials or check server logs:
```bash
docker logs finguard-test
```

### Scanner Not Healthy
```
✗ Health check: Status is unhealthy
```
**Solution:** 
1. Check external scanner connectivity:
   ```bash
   curl http://10.10.21.201:50051
   ```
2. Verify API key (if using SaaS mode)
3. Check scanner logs in container

### EICAR Not Detected
```
✗ EICAR detection: File marked as safe (should be malware)
```
**Solution:**
- Scanner may be in "disabled" security mode
- External scanner might not be connected
- Check scanner service logs

### Test Timeout
```
✗ Configuration: Verbose Enabled: Connection timeout
```
**Solution:** Increase timeout or check network connectivity

## CI/CD Integration

### GitHub Actions Example
```yaml
name: Test FinGuard

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Build Docker image
        run: docker build -t finguard:test .
      
      - name: Start FinGuard
        run: |
          docker run -d --name finguard-test \
            -p 3000:3000 \
            -e SCANNER_EXTERNAL_ADDR=${{ secrets.SCANNER_ADDR }} \
            finguard:test
          sleep 10
      
      - name: Run tests
        run: ./test-all.sh
      
      - name: Cleanup
        if: always()
        run: docker stop finguard-test && docker rm finguard-test
```

### Jenkins Pipeline Example
```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'docker build -t finguard:${BUILD_NUMBER} .'
            }
        }
        stage('Test') {
            steps {
                sh '''
                    docker run -d --name finguard-test-${BUILD_NUMBER} \
                      -p 3000:3000 \
                      -e SCANNER_EXTERNAL_ADDR=${SCANNER_ADDR} \
                      finguard:${BUILD_NUMBER}
                    sleep 10
                    ./test-all.sh
                '''
            }
        }
    }
    post {
        always {
            sh 'docker stop finguard-test-${BUILD_NUMBER} || true'
            sh 'docker rm finguard-test-${BUILD_NUMBER} || true'
        }
    }
}
```

## Adding New Tests

### Python Test Example
```python
def test_custom_feature(results: TestResults):
    """Test custom feature"""
    print(f"\n{Colors.BLUE}{Colors.BOLD}Testing Custom Feature{Colors.END}")
    
    auth = create_basic_auth(ADMIN_USER, ADMIN_PASS)
    
    try:
        response = requests.get(
            f"{BASE_URL}/api/custom",
            headers={"Authorization": auth},
            timeout=10
        )
        
        if response.status_code == 200:
            results.pass_test("Custom feature works")
        else:
            results.fail_test("Custom feature", f"HTTP {response.status_code}")
    except Exception as e:
        results.fail_test("Custom feature", str(e))
```

### Bash Test Example
```bash
echo -n "Testing custom endpoint... "
RESPONSE=$(curl -s -u "${ADMIN_USER}:${ADMIN_PASS}" "${FINGUARD_URL}/api/custom")
if echo "$RESPONSE" | grep -q '"status":"ok"'; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    exit 1
fi
```

## Performance Testing

For load testing, consider using:
- **Apache Bench**: `ab -n 1000 -c 10 http://localhost:3000/api/health`
- **wrk**: `wrk -t12 -c400 -d30s http://localhost:3000/api/health`
- **locust**: Python-based load testing framework

## License

Same as FinGuard - MIT License
